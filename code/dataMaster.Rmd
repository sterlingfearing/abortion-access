---
title: "Data Master"
output: html_document
date: '2022-07-19'
---
# Goal: Join data for analysis.

Spatial: Clinic location, geo boundaries (state, county)
Nearest Resource Analysis: Pre vs. Post Dobbs 
Demand: Age, Race, Income
Law: Pre vs. Post Dobbs
Political party: Legislative, governor, and state control 


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# load libraries

library(tidyverse)
library(here)
library(dplyr)
library(sf)

```

```{r}
# load data

##County Variables: 

# Nearest Resource Analysis
NRAraw <- st_read(here("code/data/compareNRA.shp")) 

# Estimated demand
demandRaw <- read_csv(here("code/data/demand2.csv"))

# Census Data
censusRaw <- read_csv(here("code/data/censusDataCounty.csv"))

# Number of clinics

clinicCount <- read_csv(here("code/data/numClinics.csv"))


## State Variables: 

# Law Index (pre vs. post Dobbs)
lawI <- read_csv(here("code/data/compareLaw_adjGestVals.csv"))

# Political Party
partyRaw <- read_csv(here("code/data/stateParty.csv"))




```

```{r}
# reduce # of decimal places in dstChange column
# round to 10 decimal places 

NRAraw$dstChngS <- round(NRAraw$dstChng, digit= 5)
  
```

```{r}
# rename variables in clinic Count

clinicCount <- clinicCount %>%
  rename(countRoe = clinRoe,
         countDob = clinDob)

```


```{r}
# join county level variables 

# Rename NRA variables 

NRArename <- NRAraw %>%
  rename(stateFIPS = "sttFIPS",
         countyFIPS = "cntFIPS",
         distRoe = "minDst_R",
         distDobb = "mnDst_pR",
         distDif = "dstChng",
         distDifS = "dstChngS")

# join NRA to Estimated Demand

join_NRA_demand <- left_join(NRArename, demandRaw, by= "GEOID")

# join NRA/Estimated Demand to Census Data

join_census <- left_join(join_NRA_demand, censusRaw, by= "GEOID")

# join above to clinicCount

join_county <- left_join(join_census, clinicCount, by= "GEOID")

# remove duplicates

countyData <- join_county %>%
  select("GEOID", "stateFIPS.x", "countyFIPS.x", "county", "state", "popTot", "age15_49", "whiteP", "blackP", "amIndP", "asianP", "pacIsP", "hispP", "otherP", "povPerc", "pciE", "distRoe", "distDobb", "distDif", "distDifS", "ageD", "whiteD", "blackD", "asianD", "hispD", "raceD", "p100D", "p100_199D", "p200D", "incomeD", "totalD", "countRoe", "countDob", "geometry") %>%
  rename(stateFIPS = "stateFIPS.x",
         countyFIPS = "countyFIPS.x")

# create column for clinics per capita pop 

countyData <- countyData %>%
  mutate(clinRoe = (countRoe/age15_49)*100000)

countyData <- countyData %>%
  mutate(clinDob = (countDob/age15_49)*100000)


```

```{r}
# save shapefile for county data
st_write(countyData, here("code/data/countyMaster.shp"))

# save csv
write_csv(countyData, here("code/data/countyMaster.csv"))
```

```{r}
# join state level variables

# join Political Party to Laws Under Roe
join_party_law <- left_join(partyRaw, lawI, by= "state")


# rename variables
join_state_rename <- join_party_law %>%
  rename(stateFIPS = stateFIPS.x,
         legCon = legCon.y,
         govCon = govCon.y,
         stateCon = stateCon.y) 
#select variables of interest
stateSelect <- join_state_rename %>%
  select(stateFIPS, state, stateAB, funding, medical, personal, gestRoe, gestDobb, lawRoe, lawDobb, legCon, govCon, stateCon)

# add state geometry to save as shapefile
stateGeo <- st_read(here("code/data/stateLines.shp"))
# remove DC
state_removeDC <- stateGeo %>%
  filter(!str_detect(state, "District of Columbia"))
# join
stateMaster_geo <- full_join(stateSelect, stateGeo, by = "stateFIPS")

```

```{r}
# save shapefile
st_write(stateMaster_geo, here("code/data/stateMaster.shp"))
# save as csv without geometry
write_csv(stateSelect, here("code/data/stateMaster.csv"))
```

```{r}
# apply state variables across counties

join_state_county <- left_join(countyData, stateSelect, by= "stateFIPS", keep= FALSE)





```

```{r}
# save as shapefile

st_write(join_state_county, here("code/data/dataMaster.shp"))

# save as csv

write_csv(join_state_county, here("code/data/dataMaster.csv"))
```

