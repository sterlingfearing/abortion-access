---
title: "Census Data"
author: "Sterling Fearing"
date: "5/24/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# load libraries

library(sf)
library(tidycensus)
library(tidyverse)
library(tigris)
library(tidyr)
library(here)

```


```{r}
# explore variables

sVarNames <- load_variables(2018, "acs5/subject", cache = TRUE)
pVarNames <- load_variables(2018, "acs5/profile", cache = TRUE)
otherVarNames <- load_variables(2018, "acs5", cache = TRUE)

head(pVarNames)
```
```{r}

# load population 15-49
# B01001_030, B01001_031, B01001_032, B01001_033, B01001_034, B01001_035, B01001_036, B01001_037, B01001_038, B01001_039

# female (workers) with no vehicle available. divide by total female (workers) pop
# B08014_016/B08014_015

# percent below poverty line
# DP03_0128P

countyDf <- get_acs(geography = 'county', variables = c(pop1 = "B01001_030",
                                                        pop2 = "B01001_031",
                                                        pop3 = "B01001_032",
                                                        pop4 = "B01001_033",
                                                        pop5 = "B01001_034",
                                                        pop6 = "B01001_035",
                                                        pop7 = "B01001_036",
                                                        pop8 = "B01001_037",
                                                        pop9 = "B01001_038",
                                                        pop10 = "B01001_039",
                                                        noCar = "B08014_016",
                                                        workTot = "B08014_015",
                                                        povPerc = "DP03_0128P"),
                    year = 2018, geometry = FALSE)

```
```{r}
# tidy data

# create one column for each variable, separate state and county
countyDftidy <- countyData %>%
  pivot_wider(names_from = variable, values_from = c(estimate, moe)) %>%
  separate(NAME, c("county", "state"), sep = ",")

# calculate total population for female ages 15-49 
countyDftidy$pop15_49 <- rowSums(countyDftidy[ , c(4:13)], na.rm = TRUE)

# calculate percent of women reporting no vehicle 
countyDftidy$perNoCar <- countyDftidy$estimate_noCar/countyDftidy$estimate_workTot

# the first two characters of GEOID are representative of state FIPS, the remaining are county FIPS
# separate GEOID for id based on state or county
countyDftidy <- countyDftidy %>%
  separate(GEOID, into = c('stateFIPS', 'countyFIPS'), sep = 2, remove = FALSE)

# select variables of interest 
countyDftidy <- countyDftidy %>%
  select(GEOID, stateFIPS, countyFIPS, county, state, estimate_povPerc, pop15_49, perNoCar) %>%
  rename(povPerc = estimate_povPerc) 

# remove PR, AK, HI
censusDataCounty <- countyDftidy %>%
  filter(stateFIPS != "02" & stateFIPS != "72" & stateFIPS != "15")

# save as csv
write_csv(censusDataCounty, here("data/censusDataCounty.csv"))

```


